name: Auto PR from Staging to Main

on:
  push:
    branches:
      - staging

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'

    steps:
      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          if gh pr list --repo "$GH_REPO" --head "staging" --base "main" --json "number" | grep -q "number"; then
            echo "A PR from staging to main already exists. Skipping."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "No existing PR found. Proceeding to create one."
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request using GitHub CLI
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh pr create \
            --repo "$GH_REPO" \
            --base "main" \
            --head "staging" \
            --title "ðŸš€ Auto PR: Sync staging â†’ main" \
            --body "This PR was automatically created after a push to \`staging\`. Please review and merge if everything is OK." \
            --label "auto-pr"